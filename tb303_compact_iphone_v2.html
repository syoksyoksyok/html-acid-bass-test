<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Web TB-303 – Compact iPhone v2</title>
  <style>
    :root{
      --bg:#e0e0e0;--panel:#cfcfcf;--line:#b6b6b6;--fg:#222;
      --led-off:#444;--led-accent:#ff6a00;--led-note:#ffd700;--led-play:#21c55d;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color: transparent;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui, -apple-system, "Helvetica Neue", Arial;}
    body{display:flex;justify-content:center;align-items:flex-start;min-height:100vh;}
    .synth{
      width:100%;max-width:420px;background:var(--panel);
      border:1px solid var(--line);border-radius:16px;padding:8px;
      box-shadow:0 6px 18px rgba(0,0,0,.15);
    }
    h1{font-size:15px;text-align:center;margin:0 0 6px 0}
    /* ====== Controls (2 columns on iPhone) ====== */
    .controls{
      display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px;
      padding:6px;border-radius:12px;background:#d9d9d9;border:1px solid var(--line);
    }
    .ctrl{display:flex;flex-direction:column;align-items:center;gap:4px;}
    .ctrl label{font-size:9px;font-weight:700;letter-spacing:.2px;text-transform:uppercase}
    /* Knob-like ranges set to 1/3 original (≈56px → 18.7px) -> use 20px */
    input[type="range"].knob{
      -webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;
      background:#2b2b2b;border:2px solid #3f3f3f;position:relative;
      box-shadow:inset 0 0 0 1px #0003, 1px 1px 2px #fff9, -1px -1px 2px #0006;
      touch-action:none;
      transform-origin:center center;
    }
    input[type="range"].knob::-webkit-slider-thumb{ -webkit-appearance:none; width:0; height:0;}
    input[type="range"].knob::before{
      content:""; position:absolute; left:50%; top:3px; transform:translateX(-50%);
      width:2px; height:6px; border-radius:2px; background:#eee;
    }
    /* Waveform switch button */
    .switch{padding:4px 8px;border:1px solid var(--line);border-radius:8px;background:#bbb;font-weight:700;font-size:11px}
    .transport{
      display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px;align-items:center;
    }
    .transport .row{grid-column:span 2;display:flex;gap:6px;justify-content:space-between;align-items:center}
    .btn{
      padding:6px 8px;border-radius:8px;border:1px solid var(--line);background:#bdbdbd;font-weight:700;font-size:12px;
    }
    #play-stop.playing{background:var(--led-play);color:#fff}
    .lcd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas; font-size:12px;
      background:#333;color:#0f0;border-radius:6px;padding:3px 5px;min-width:36px;text-align:center}
    /* Sequencer: smaller cells */
    .seq{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;margin:8px 0;}
    .step{
      display:flex;flex-direction:column;align-items:center;gap:2px;
      padding:2px;border-radius:5px;background:#d9d9d9;border:1px solid var(--line)
    }
    .led{width:10px;height:10px;border-radius:50%;background:var(--led-off);border:2px solid #222;box-shadow:inset 0 0 3px rgba(0,0,0,.45);}
    .led.active{background:var(--led-note)}
    .led.active.accent{background:var(--led-accent)}
    .led.playing{box-shadow:0 0 6px 1px var(--led-play)}
    .note-controls{display:flex;gap:2px}
    .note-controls button{width:14px;height:14px;line-height:14px;font-size:9px;padding:0;border-radius:3px;border:1px solid #999;background:#bdbdbd}
    .note-controls button.active{background:var(--led-accent);color:#fff;border-color:#f90}
    .note-controls button:nth-child(4).active{background:var(--led-note);color:#000;border-color:#fc0}
    .help{font-size:10px;color:#3339;text-align:center}
    /* Extreme small screens */
    @media (max-width:390px){
      .synth{max-width:360px}
    }
  </style>
</head>
<body>
  <div class="synth" id="app">
    <h1>Web TB-303 (Compact v2)</h1>

    <div class="controls">
      <div class="ctrl">
        <label>Wave</label>
        <button id="waveform" class="switch">SAW</button>
      </div>
      <div class="ctrl">
        <label>Cutoff</label>
        <input id="cutoff" class="knob" type="range" min="100" max="8000" value="800" step="1">
      </div>
      <div class="ctrl">
        <label>Res</label>
        <input id="resonance" class="knob" type="range" min="0" max="30" value="5" step="0.1">
      </div>
      <div class="ctrl">
        <label>Env</label>
        <input id="envMod" class="knob" type="range" min="0" max="5000" value="2000" step="1">
      </div>
      <div class="ctrl">
        <label>Decay</label>
        <input id="decay" class="knob" type="range" min="0.05" max="1.0" value="0.3" step="0.01">
      </div>
    </div>

    <div class="seq" id="sequencer"></div>

    <div class="transport">
      <button id="play-stop" class="btn">Play</button>
      <button id="randomize" class="btn">Randomize</button>
      <div class="row">
        <div style="display:flex;align-items:center;gap:6px;flex:1;">
          <span style="font-size:11px;font-weight:700">BPM</span>
          <input id="bpm" type="range" min="60" max="180" value="128" step="1" style="flex:1">
          <span id="bpm-display" class="lcd">128</span>
        </div>
        <div style="display:flex;align-items:center;gap:6px;flex:1;">
          <span style="font-size:11px;font-weight:700">LEN</span>
          <input id="length" type="range" min="1" max="16" value="16" step="1" style="flex:1">
          <span id="length-display" class="lcd">16</span>
        </div>
      </div>
    </div>

    <p class="help">ノブは1/3サイズ、ステップ枠を縮小。必要ならさらに極小化も可能です。</p>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let audioCtx;
      let isPlaying = false;
      let currentStep = 0;
      let nextNoteTime = 0.0;
      let timerID;
      const MAX_STEPS = 16;
      let sequenceLength = 16;
      let baseNote = 36;
      const sequencerContainer = document.getElementById('sequencer');
      const playStopButton = document.getElementById('play-stop');
      const randomizeButton = document.getElementById('randomize');
      const bpmSlider = document.getElementById('bpm');
      const bpmDisplay = document.getElementById('bpm-display');
      const lengthSlider = document.getElementById('length');
      const lengthDisplay = document.getElementById('length-display');
      const knobs = {
        waveform: document.getElementById('waveform'),
        cutoff: document.getElementById('cutoff'),
        resonance: document.getElementById('resonance'),
        envMod: document.getElementById('envMod'),
        decay: document.getElementById('decay'),
      };

      // Build sequencer grid (8x2 visual, 16 logical)
      function initGrid() {
        for (let i = 0; i < MAX_STEPS; i++) {
          const stepEl = document.createElement('div');
          stepEl.classList.add('step');
          stepEl.dataset.index = i;
          const led = document.createElement('div');
          led.classList.add('led');
          led.addEventListener('click', () => toggleNote(i));
          const noteControls = document.createElement('div');
          noteControls.classList.add('note-controls');
          const up = document.createElement('button'); up.textContent = '▲';
          up.addEventListener('click', () => changePitch(i, 1));
          const down = document.createElement('button'); down.textContent = '▼';
          down.addEventListener('click', () => changePitch(i, -1));
          const accent = document.createElement('button'); accent.textContent = 'A';
          accent.addEventListener('click', () => toggleAccent(i));
          const slide = document.createElement('button'); slide.textContent = 'S';
          slide.addEventListener('click', () => toggleSlide(i));
          noteControls.append(up, down, accent, slide);
          stepEl.append(led, noteControls);
          sequencerContainer.appendChild(stepEl);
        }
      }

      // State
      let sequence = [];
      function generateRandomSequence() {
        const scale = [0,2,3,5,7,8,10];
        let temp = [], lastActive=false;
        for (let i=0;i<MAX_STEPS;i++){
          const active = Math.random() < 0.4;
          const pitch = scale[Math.floor(Math.random()*scale.length)];
          const octave = Math.random() < 0.7 ? 1 : 0;
          const accent = active && Math.random() < 0.15;
          const slide = active && lastActive && Math.random() < 0.1;
          temp.push({active, pitch, octave, accent, slide});
          lastActive = active;
        }
        sequence = temp;
      }

      function updateUI() {
        sequence.forEach((note, i) => {
          const stepEl = sequencerContainer.children[i];
          if (!stepEl) return;
          const led = stepEl.querySelector('.led');
          led.classList.toggle('active', note.active);
          led.classList.toggle('accent', note.active && note.accent);
          const accentButton = stepEl.querySelector('.note-controls button:nth-child(3)');
          accentButton.classList.toggle('active', note.accent);
          const slideButton = stepEl.querySelector('.note-controls button:nth-child(4)');
          slideButton.classList.toggle('active', note.slide);
        });
      }

      function updatePlayingLED(i) {
        document.querySelectorAll('.led.playing').forEach(el => el.classList.remove('playing'));
        const led = sequencerContainer.children[i]?.querySelector('.led');
        if (led) led.classList.add('playing');
      }

      function toggleNote(i){ sequence[i].active = !sequence[i].active; if(!sequence[i].active){ sequence[i].accent=false; sequence[i].slide=false;} updateUI(); }
      function toggleAccent(i){ if(sequence[i].active){ sequence[i].accent = !sequence[i].accent; updateUI(); } }
      function toggleSlide(i){ if(sequence[i].active){ sequence[i].slide = !sequence[i].slide; updateUI(); } }
      function changePitch(i, dir){
        if(!sequence[i].active) return;
        let cp = sequence[i].pitch + sequence[i].octave*12;
        cp += dir; cp = Math.max(0, Math.min(48, cp));
        sequence[i].octave = Math.floor(cp/12);
        sequence[i].pitch = cp % 12;
      }

      // Audio
      function initAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
      function midiToFreq(m){ return Math.pow(2, (m - 69)/12)*440; }
      function playNote(note, time){
        if(!note.active) return;
        const osc = audioCtx.createOscillator();
        const filter = audioCtx.createBiquadFilter();
        const vca = audioCtx.createGain();
        const env = audioCtx.createGain();

        osc.type = knobs.waveform.textContent.toLowerCase()==='saw' ? 'sawtooth':'square';
        const pitch = baseNote + note.octave*12 + note.pitch;
        osc.frequency.setValueAtTime(midiToFreq(pitch), time);

        filter.type = 'lowpass';
        const cutoff = parseFloat(knobs.cutoff.value);
        filter.frequency.setValueAtTime(cutoff, time);
        filter.Q.setValueAtTime(parseFloat(knobs.resonance.value), time);

        const decay = parseFloat(knobs.decay.value);
        const envMod = parseFloat(knobs.envMod.value);
        env.gain.setValueAtTime(1, time); env.gain.linearRampToValueAtTime(0, time+decay);

        const filterEnv = audioCtx.createGain();
        filterEnv.gain.setValueAtTime(note.accent ? envMod*1.5 : envMod, time);
        filterEnv.gain.linearRampToValueAtTime(0, time + decay*1.2);
        filterEnv.connect(filter.frequency);

        vca.gain.setValueAtTime(note.accent ? 1.0 : 0.7, time);
        vca.gain.linearRampToValueAtTime(0, time + decay + 0.05);

        // Slide
        if(note.slide && currentStep>0){
          const prevIdx = (currentStep - 1 + sequenceLength) % sequenceLength;
          const prev = sequence[prevIdx];
          if(prev.active){
            const prevPitch = baseNote + prev.octave*12 + prev.pitch;
            osc.frequency.setValueAtTime(midiToFreq(prevPitch), time);
            osc.frequency.linearRampToValueAtTime(midiToFreq(pitch), time + 0.05);
          }
        }

        osc.connect(filter); filter.connect(vca); vca.connect(audioCtx.destination);
        env.connect(vca.gain);
        osc.start(time); osc.stop(time + decay + 0.1);
      }

      const scheduleAhead = 0.1;
      function scheduler(){
        while(nextNoteTime < audioCtx.currentTime + scheduleAhead){
          if(currentStep >= sequenceLength) currentStep = 0;
          const note = sequence[currentStep];
          playNote(note, nextNoteTime);
          const spb = 60.0 / parseFloat(bpmSlider.value);
          nextNoteTime += 0.25 * spb;
          updatePlayingLED(currentStep);
          currentStep = (currentStep + 1) % sequenceLength;
        }
        timerID = setTimeout(scheduler, 25);
      }

      function togglePlayback(){
        initAudio();
        isPlaying = !isPlaying;
        if(isPlaying){
          currentStep = 0;
          nextNoteTime = audioCtx.currentTime;
          scheduler();
          playStopButton.textContent = 'Stop';
          playStopButton.classList.add('playing');
        }else{
          clearTimeout(timerID);
          playStopButton.textContent = 'Play';
          playStopButton.classList.remove('playing');
          document.querySelectorAll('.led.playing').forEach(el=>el.classList.remove('playing'));
        }
      }

      function updateSeqVisibility(){
        const steps = sequencerContainer.children;
        for(let i=0;i<MAX_STEPS;i++){
          steps[i].style.display = i < sequenceLength ? 'flex' : 'none';
        }
      }

      // Wave switch
      knobs.waveform.addEventListener('click', ()=>{
        knobs.waveform.textContent = knobs.waveform.textContent==='SAW' ? 'SQUARE' : 'SAW';
      });

      // BPM/LEN
      bpmSlider.addEventListener('input', e => bpmDisplay.textContent = e.target.value);
      lengthSlider.addEventListener('input', e => {
        sequenceLength = parseInt(e.target.value,10);
        lengthDisplay.textContent = sequenceLength;
        updateSeqVisibility();
        if(isPlaying && currentStep >= sequenceLength) currentStep = 0;
      });

      // Play/Randomize
      playStopButton.addEventListener('click', togglePlayback);
      randomizeButton.addEventListener('click', () => { generateRandomSequence(); updateUI(); });

      // ===== Knob drag logic remains (works at small size) =====
      const rotaryKnobs = document.querySelectorAll('input.knob');
      rotaryKnobs.forEach(knob=>{
        const updateRotation = ()=>{
          const min = parseFloat(knob.min), max = parseFloat(knob.max), val = parseFloat(knob.value);
          const pct = (val - min)/(max - min);
          const deg = -135 + pct*270;
          knob.style.transform = `rotate(${deg}deg)`;
        };
        updateRotation();
        knob.addEventListener('input', updateRotation);

        // Mouse
        knob.addEventListener('mousedown', e => startDrag(e.clientY, e.shiftKey));
        // Touch
        knob.addEventListener('touchstart', e => {
          const t = e.touches[0];
          startDrag(t.clientY, e.shiftKey || false, true);
        }, {passive:false});

        function startDrag(startY, fine=false, isTouch=false){
          const initial = parseFloat(knob.value);
          const min = parseFloat(knob.min), max = parseFloat(knob.max), range = max - min;
          function move(clientY, shiftKey){
            const deltaY = startY - clientY;
            const sens = (shiftKey || fine) ? 0.1 : 0.5;
            let val = initial + (deltaY/100)*range*sens;
            val = Math.max(min, Math.min(max, val));
            knob.value = val;
            knob.dispatchEvent(new Event('input'));
          }
          function onMouseMove(e){ e.preventDefault(); move(e.clientY, e.shiftKey); }
          function onMouseUp(){ document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); }
          function onTouchMove(e){ if(!e.touches[0]) return; move(e.touches[0].clientY, false); }
          function onTouchEnd(){ document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', onTouchEnd); }

          if(isTouch){
            document.addEventListener('touchmove', onTouchMove, {passive:false});
            document.addEventListener('touchend', onTouchEnd);
          }else{
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
          }
        }
      });

      // Init
      initGrid();
      generateRandomSequence();
      updateUI();
      updateSeqVisibility();
    });
  </script>
</body>
</html>
